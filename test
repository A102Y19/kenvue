# Path to server list file
$ServerList = "\\awsusdmjfsxn01.jnj.com\eth_qa2_omp\Task_Scheduler\Server_list.txt"

# Task folder path
$TaskPath = "\OMP Dispatcher\"   # updated folder

# Loop through each server
foreach ($server in Get-Content $ServerList) {
    Write-Host "Processing server: $server ..." -ForegroundColor Cyan
    try {
        Invoke-Command -ComputerName $server -ScriptBlock {
            param($TaskPath)

            $tasks = Get-ScheduledTask -TaskPath $TaskPath -ErrorAction SilentlyContinue
            if ($tasks) {
                foreach ($task in $tasks) {
                    # Check if the task is already running
                    $status = (Get-ScheduledTaskInfo -TaskName $task.TaskName -TaskPath $TaskPath).State
                    if ($status -ne "Running") {
                        Start-ScheduledTask -TaskName $task.TaskName -TaskPath $TaskPath
                        Write-Host "[$env:COMPUTERNAME] - Task '$($task.TaskName)' started successfully." -ForegroundColor Green
                    } else {
                        Write-Host "[$env:COMPUTERNAME] - Task '$($task.TaskName)' is already running." -ForegroundColor Yellow
                    }
                }
            } else {
                Write-Host "[$env:COMPUTERNAME] - No tasks found in folder '$TaskPath'." -ForegroundColor Yellow
            }
        } -ArgumentList $TaskPath -ErrorAction Stop
    }
    catch {
        Write-Host "[$server] - Failed to run tasks. Error: $_" -ForegroundColor Red
    }
}

Write-Host "All done!" -ForegroundColor Cyan
