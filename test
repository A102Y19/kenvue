$ServerList = "\\awsusdmkfsxn01.jnj.com\mdd_tst_omp\OMP_JNJ_MD_ATOM_LAB\OMPartners\development\dispatcher\bin\Automation\task_start\Server_list.txt"
$TaskFolder = "Agent_Monitoring"

foreach ($server in Get-Content $ServerList) {
    Write-Host "Processing server: $server ..." -ForegroundColor Cyan
    try {
        Invoke-Command -ComputerName $server -ScriptBlock {
            param($TaskFolder)

            $tasks = Get-ScheduledTask | Where-Object { $_.TaskPath -like "*\$TaskFolder*" }

            if ($tasks) {
                foreach ($task in $tasks) {
                    $taskName = $task.TaskName
                    $taskPath = $task.TaskPath

                    # Get last run time before triggering
                    $lastRunBefore = (Get-ScheduledTaskInfo -TaskName $taskName -TaskPath $taskPath).LastRunTime

                    # Trigger the task
                    try {
                        Start-ScheduledTask -TaskName $taskName -TaskPath $taskPath -ErrorAction Stop
                        Start-Sleep -Seconds 5   # give it a few seconds to actually start
                        
                        # Get last run time after triggering
                        $lastRunAfter = (Get-ScheduledTaskInfo -TaskName $taskName -TaskPath $taskPath).LastRunTime

                        if ($lastRunAfter -gt $lastRunBefore) {
                            Write-Host "[$env:COMPUTERNAME] - Task '$taskName' ran successfully at $lastRunAfter." -ForegroundColor Green
                        } else {
                            Write-Host "[$env:COMPUTERNAME] - Task '$taskName' did NOT run." -ForegroundColor Red
                        }
                    }
                    catch {
                        Write-Host "[$env:COMPUTERNAME] - Task '$taskName' could NOT start. Error: $_" -ForegroundColor Red
                    }
                }
            } else {
                Write-Host "[$env:COMPUTERNAME] - No tasks found in folder '$TaskFolder'." -ForegroundColor Yellow
            }
        } -ArgumentList $TaskFolder -ErrorAction Stop
    }
    catch {
        Write-Host "[$server] - Failed to connect/run tasks. Error: $_" -ForegroundColor Red
    }
}

Write-Host "All done!" -ForegroundColor Cyan
